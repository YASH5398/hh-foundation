rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================= HELPERS ================= */
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isAgent() {
      return isAuth()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }

    /* ================= PUBLIC ================= */
    match /faqs/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /terms/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /rules/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /settings/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* ================= USERS (FIXED) ================= */
    match /users/{uid} {

      // ✅ SIGNUP (CRITICAL FIX)
      allow create: if isAuth() && request.auth.uid == uid;

      // ✅ READ + LIST (needed after signup)
      allow read, list: if isAuth();

      // ✅ UPDATE
      allow update: if isAuth()
        && (request.auth.uid == uid || isAdmin());

      allow delete: if false;
    }

    /* ================= LEADERBOARD ================= */
    match /leaderboard/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    match /directReferrals/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    /* ================= APP CONFIG ================= */
    match /appSettings/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    match /appConfig/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    match /tickerMessages/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    /* ================= NOTIFICATIONS ================= */
    match /notifications/{id} {
      allow read, list: if isAuth()
        && resource.data.uid == request.auth.uid;
      allow write: if isAdmin();
    }

    /* ================= SEND HELP ================= */
    match /sendHelp/{id} {
      allow read, list: if isAuth()
        && (resource.data.senderUid == request.auth.uid
            || resource.data.receiverUid == request.auth.uid);
      
      // Allow receiver to update payment request fields
      allow update: if isAuth()
        && request.auth.uid == resource.data.receiverUid
        && (request.resource.data.keys().hasOnly(['paymentRequested', 'lastPaymentRequestAt'])
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['paymentRequested', 'lastPaymentRequestAt']));
      
      // Allow sender to reset payment requested flag when payment is done
      allow update: if isAuth()
        && request.auth.uid == resource.data.senderUid
        && request.resource.data.keys().hasOnly(['paymentRequested'])
        && request.resource.data.paymentRequested == false;
      
      allow write: if isAdmin();
    }

    /* ================= RECEIVE HELP ================= */
    match /receiveHelp/{id} {
      allow read, list: if isAuth()
        && (resource.data.senderUid == request.auth.uid
            || resource.data.receiverUid == request.auth.uid);
      
      // Allow receiver to update payment request fields
      allow update: if isAuth()
        && request.auth.uid == resource.data.receiverUid
        && (request.resource.data.keys().hasOnly(['paymentRequested', 'lastPaymentRequestAt'])
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['paymentRequested', 'lastPaymentRequestAt']));
      
      // Allow sender to reset payment requested flag when payment is done
      allow update: if isAuth()
        && request.auth.uid == resource.data.senderUid
        && request.resource.data.keys().hasOnly(['paymentRequested'])
        && request.resource.data.paymentRequested == false;
      
      allow write: if isAdmin();
    }

    /* ================= CHAT ================= */
    match /chatbotChats/{uid} {
      allow read, create, update: if isAuth()
        && request.auth.uid == uid;

      match /messages/{msgId} {
        allow read, create: if isAuth()
          && request.auth.uid == uid;
      }
    }

    /* ================= CHATS ================= */
    match /chats/{chatId} {
      // CREATE: Allow if user is in participants array
      allow create: if isAuth()
        && request.auth.uid in request.resource.data.participants;
      
      // READ/UPDATE: Allow if user is in participants array
      allow read, get, update: if isAuth()
        && request.auth.uid in resource.data.participants;

      // Messages subcollection
      match /messages/{messageId} {
        // READ: Allow if user is in parent chat participants
        allow read, list: if isAuth()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // CREATE: Allow if user is the sender
        allow create: if isAuth()
          && request.auth.uid == request.resource.data.senderUid;
        
        // UPDATE: Allow if user is participant (for status updates)
        allow update: if isAuth()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }

      // Typing subcollection
      match /typing/{userId} {
        // READ: Allow if user is participant
        allow read: if isAuth()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // WRITE: Allow if user is writing their own status
        allow write: if isAuth()
          && request.auth.uid == userId;
      }
    }

    /* ================= E-PIN ================= */
    match /epinRequests/{id} {
      allow create: if isAuth()
        && request.resource.data.userId == request.auth.uid;

      allow read, list: if isAuth()
        && resource.data.userId == request.auth.uid;
    }

    match /epins/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    /* ================= SYSTEM ================= */
    match /systemConfig/{id} {
      allow read, list: if isAuth();
      allow write: if isAdmin();
    }

    /* ================= FINAL DENY ================= */
    match /{doc=**} {
      allow read, write: if false;
    }
  }
}
