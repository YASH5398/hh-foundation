rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================= HELPERS ================= */
    function isAuth() {
      return request.auth != null;
    }

    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }

    function isAdmin() {
      return isAuth()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isAgent() {
      return isAuth()
        && isEmailVerified()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }

    /* ================= PUBLIC ================= */
    match /faqs/{id} { allow read: if true; allow write: if isAdmin(); }
    match /terms/{id} { allow read: if true; allow write: if isAdmin(); }
    match /rules/{id} { allow read: if true; allow write: if isAdmin(); }
    match /settings/{id} { allow read: if true; allow write: if isAdmin(); }
    
    match /testimonials/{id} { 
      allow read, list: if true; 
      allow create: if isAuth(); 
      allow update, delete: if isAdmin(); 
    }

    /* ================= USERS ================= */
    match /users/{uid} {
      allow create: if isAuth() && request.auth.uid == uid;
      allow read, list: if isAuth() || isAdmin();
      allow update: if isAuth() && (request.auth.uid == uid || isAdmin() || isAgent());
      allow delete: if false;
    }

    /* ================= AGENT SPECIFIC ================= */
    
    match /agentChatRequests/{id} {
      allow read, list: if isAdmin() || isAgent();
      allow create: if isAuth(); 
      allow update: if isAdmin() || isAgent();
    }

    match /agentAdminChats/{chatId} {
      allow read, list: if isAdmin() || (isAgent() && resource.data.agentUid == request.auth.uid);
      allow create: if isAgent();
      allow update: if isAdmin();

      match /messages/{messageId} {
        allow read, list: if isAdmin() || (isAgent() && get(/databases/$(database)/documents/agentAdminChats/$(chatId)).data.agentUid == request.auth.uid);
        allow create: if isAdmin() || (isAgent() && get(/databases/$(database)/documents/agentAdminChats/$(chatId)).data.agentUid == request.auth.uid);
      }
    }

    match /spamLogs/{id} {
      allow read, list: if isAdmin() || isAgent();
      allow create: if isAdmin();
    }

    match /agentRequests/{id} {
      allow read, list: if isAdmin() || isAgent() || (isAuth() && resource.data.agentId == request.auth.uid);
      allow create: if isAuth();
      allow update: if isAdmin() || isAgent();
    }

    match /agentChats/{chatId} {
        allow read, list, get: if isAdmin() || isAgent() || (isAuth() && resource.data.userId == request.auth.uid);
        allow create, update: if isAdmin() || isAgent();
        
        match /messages/{messageId} {
            allow read, list: if isAdmin() || isAgent() || (isAuth() && get(/databases/$(database)/documents/agentChats/$(chatId)).data.userId == request.auth.uid);
            allow create: if isAdmin() || isAgent() || (isAuth() && get(/databases/$(database)/documents/agentChats/$(chatId)).data.userId == request.auth.uid);
        }
    }

    match /supportTickets/{id} {
      allow read, list: if isAdmin() 
        || isAgent()
        || (isAuth() && resource.data.userId == request.auth.uid);

      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;

      allow update: if isAdmin() 
        || isAgent()
        || (isAuth() && resource.data.userId == request.auth.uid);

      match /messages/{messageId} {
        allow read, list: if isAdmin()
          || isAgent()
          || (isAuth() && get(/databases/$(database)/documents/supportTickets/$(id)).data.userId == request.auth.uid);
        
        allow create: if isAdmin()
          || isAgent()
          || (isAuth() && get(/databases/$(database)/documents/supportTickets/$(id)).data.userId == request.auth.uid);
      }
    }

    /* ================= LEADERBOARD ================= */
    match /leaderboard/{id} {
      allow read, list: if isAuth() || isAgent() || isAdmin();
      allow write: if isAdmin();
    }

    match /directReferrals/{id} {
      allow read, list: if isAuth() || isAdmin();
      allow write: if isAdmin();
    }

    /* ================= APP CONFIG / SYSTEM ================= */
    match /appSettings/{id} { allow read, list: if isAuth() || isAdmin(); allow write: if isAdmin(); }
    match /appConfig/{id} { allow read, list: if isAuth() || isAdmin(); allow write: if isAdmin(); }
    match /tickerMessages/{id} { allow read, list: if isAuth() || isAdmin(); allow write: if isAdmin(); }
    match /systemConfig/{id} { allow read, list: if isAuth() || isAdmin(); allow write: if isAdmin(); }
    
    /* ================= ADMIN INSIGHTS ================= */
    match /adminInsights/{id} {
      allow read, list: if isAdmin();
      allow write: if isAdmin();
    }

    /* ================= NOTIFICATIONS ================= */
    match /notifications/{id} {
      allow read, list: if isAuth()
        && (resource.data.uid == request.auth.uid || isAdmin() || isAgent()); 
      allow write: if isAdmin();
    }

    match /agentNotifications/{id} {
      allow read, list: if isAuth() && (isAgent() || isAdmin());
      allow create: if isAuth(); 
      allow update: if isAuth() && (isAgent() || isAdmin());
      allow delete: if isAdmin();
    }

    /* ================= SEND HELP ================= */
    match /sendHelp/{id} {
      allow read, list: if isAuth()
        && (resource.data.senderUid == request.auth.uid
            || resource.data.receiverUid == request.auth.uid
            || isAdmin()
            || isAgent());
      
      allow update: if isAuth()
        && request.auth.uid == resource.data.receiverUid
        && (request.resource.data.keys().hasOnly(['paymentRequested', 'lastPaymentRequestAt'])
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['paymentRequested', 'lastPaymentRequestAt']));
      
      allow update: if isAuth()
        && request.auth.uid == resource.data.senderUid
        && request.resource.data.keys().hasOnly(['paymentRequested'])
        && request.resource.data.paymentRequested == false;
      
      allow update: if (isAdmin() || isAgent()) 
        && request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'verifiedBy', 'verifiedAt', 'updatedAt']);

      allow write: if isAdmin();
    }

    /* ================= RECEIVE HELP ================= */
    match /receiveHelp/{id} {
      allow read, list: if isAuth()
        && (resource.data.senderUid == request.auth.uid
            || resource.data.receiverUid == request.auth.uid
            || isAdmin()
            || isAgent());
      
      allow update: if isAuth()
        && request.auth.uid == resource.data.receiverUid
        && (request.resource.data.keys().hasOnly(['paymentRequested', 'lastPaymentRequestAt'])
            || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['paymentRequested', 'lastPaymentRequestAt']));
      
      allow update: if isAuth()
        && request.auth.uid == resource.data.senderUid
        && request.resource.data.keys().hasOnly(['paymentRequested'])
        && request.resource.data.paymentRequested == false;

      allow update: if (isAdmin() || isAgent()) 
         && request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'verifiedBy', 'verifiedAt', 'updatedAt']);
      
      allow write: if isAdmin();
    }

    /* ================= CHAT (Bot) ================= */
    match /chatbotChats/{uid} {
      allow read, create, update: if isAuth() && request.auth.uid == uid;
      match /messages/{msgId} {
        allow read, create: if isAuth() && request.auth.uid == uid;
      }
    }

    /* ================= CHATS (P2P + Support) ================= */
    match /chats/{chatId} {
      allow create: if isAuth() && request.auth.uid in request.resource.data.participants;
      
      allow read, get, update: if isAuth()
        && (request.auth.uid in resource.data.participants || isAgent() || isAdmin());

      match /messages/{messageId} {
        allow read, list: if isAuth()
          && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants || isAgent() || isAdmin());
        
        allow create: if isAuth()
          && (request.auth.uid == request.resource.data.senderUid || isAgent() || isAdmin());
        
        allow update: if isAuth()
          && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants || isAgent() || isAdmin());
      }

      match /typing/{userId} {
        allow read: if isAuth()
          && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants || isAgent() || isAdmin());
        allow write: if isAuth() && request.auth.uid == userId;
      }
    }

    /* ================= E-PIN ================= */
    match /epinRequests/{id} {
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow read, list: if isAuth()
        && (resource.data.userId == request.auth.uid || isAgent() || isAdmin());
      allow update, delete: if isAdmin();
    }

    match /epins/{id} {
      allow read, list: if isAuth() || isAgent() || isAdmin(); 
      allow write: if isAdmin();
    }

    /* ================= FINAL DENY ================= */
    match /{doc=**} {
      allow read, write: if false;
    }
  }
}
