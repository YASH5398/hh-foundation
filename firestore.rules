<<<<<<< HEAD
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    function isAgent() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }

    function isAdminOrAgent() {
      return isAdmin() || isAgent();
    }

    match /faqs/{docId} {
      allow read: if true;
      allow write, create, update, delete: if isAdmin();
    }

    match /terms/{docId} {
      allow read: if true;
      allow write, create, update, delete: if isAdmin();
    }

    match /rules/{docId} {
      allow read: if true;
      allow write, create, update, delete: if isAdmin();
    }

    match /settings/{docId} {
      allow read: if docId in ['faqs', 'terms', 'rules'];
      allow write, create, update, delete: if isAdmin();
    }

    // REQUIRED FOR DASHBOARD / LEADERBOARD / REFERRALS
    match /leaderboard/{docId} {
      allow read, list: if request.auth != null;
      allow write, create, update, delete: if isAdmin();
    }

    match /directReferrals/{docId} {
      allow read, list: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users: self read + allow list for dashboard queries
    match /users/{uid} {
      allow create: if isAuthenticated() && request.auth.uid == uid;
      allow read: if request.auth != null && request.auth.uid == uid;
      allow list: if request.auth != null;
      allow update: if isAuthenticated() && request.auth.uid == uid;
      allow delete: if false;
    }

    // Dashboard reads ticker settings
    match /appSettings/{docId} {
      allow read, list: if isAuthenticated();
      allow write, create, update, delete: if isAdmin();
    }

    // Notifications are read by users; writes happen via Admin SDK in callable
    match /notifications/{notificationId} {
      allow read, list: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow write, create, update, delete: if false;
    }

    // Send/Receive help are read by participants; writes happen via Cloud Functions/Admin
    match /sendHelp/{helpId} {
      allow read, list: if isAuthenticated() && (resource.data.senderUid == request.auth.uid || resource.data.receiverUid == request.auth.uid);
      allow write, create, update, delete: if isAdmin();
    }

    match /receiveHelp/{helpId} {
      allow read, list: if isAuthenticated() && (resource.data.senderUid == request.auth.uid || resource.data.receiverUid == request.auth.uid);
      allow write, create, update, delete: if isAdmin();
    }

    // Chatbot chat history is stored per-user
    match /chatbotChats/{uid} {
      allow read, create, update: if isAuthenticated() && request.auth.uid == uid;
      allow delete: if false;

      match /messages/{messageId} {
        allow read, create: if isAuthenticated() && request.auth.uid == uid;
        allow update, delete: if false;
      }
    }

    // E-PIN requests are created and viewed by the requesting user
    match /epinRequests/{requestId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, list: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    match /epins/{docId} {
      allow read, list: if request.auth != null;
      allow write: if isAdmin();
    }

    // System configuration (UPI settings, QR images, etc.) - read access for authenticated users
    match /systemConfig/{docId} {
      allow read: if isAuthenticated();
      allow write, create, update, delete: if isAdmin();
    }

    // ADMIN OVERRIDE
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
=======
rules_version = '2'; service cloud.firestore { match /databases/{database}/documents {

function isAdmin() {
  return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
}

function isAgent() {
  return request.auth != null &&
    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
}

function isAuthenticated() {
  return request.auth != null;
}

function isAdminOrAgent() {
  return isAdmin() || isAgent();
}

// GLOBAL ADMIN OVERRIDE - Full access to ALL collections for admins
match /{document=**} {
  allow read, write, create, update, delete: if isAdmin();
}


match /users/{userId} {
  allow read, write: if request.auth != null;
}

match /admins/{docId} {
  allow read, write, create, list: if isAuthenticated() && isAdmin();
}

match /agents/{agentId} {
  allow read: if isAuthenticated() && (request.auth.uid == agentId || isAdmin());
  allow write, create: if isAuthenticated() && isAdmin();
  allow list: if isAuthenticated() && isAdminOrAgent();
}

match /chatRooms/{chatId} {
  allow read: if isAuthenticated() && (request.auth.uid in resource.data.participants || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid in resource.data.participants || isAdminOrAgent());
  allow create: if isAuthenticated() && (request.auth.uid in request.resource.data.participants || isAdminOrAgent());
  allow list: if isAuthenticated();

  match /messages/{messageId} {
    allow read: if isAuthenticated() && (request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatId)).data.participants || isAdminOrAgent());
    allow write: if isAuthenticated() && (request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatId)).data.participants || isAdminOrAgent());
    allow create: if isAuthenticated() && (request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatId)).data.participants || isAdminOrAgent());
    allow list: if isAuthenticated() && (request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatId)).data.participants || isAdminOrAgent());
  }
}

match /agentChats/{chatId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.agentId || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.agentId || isAdminOrAgent());
  allow create: if isAuthenticated();
  allow list: if isAuthenticated() && isAdminOrAgent();

  match /messages/{messageId} {
    allow read: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.userId || request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.agentId || isAdminOrAgent());
    allow write: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.userId || request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.agentId || isAdminOrAgent());
    allow create: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.userId || request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.agentId || isAdminOrAgent());
    allow list: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.userId || request.auth.uid == get(/databases/$(database)/documents/agentChats/$(chatId)).data.agentId || isAdminOrAgent());
  }
}

match /chats/{chatId} {
  allow read, list, create, update, delete: if request.auth != null;

  match /messages/{messageId} {
    allow read, list, create, update, delete: if request.auth != null;
  }
}


match /sendHelp/{docId} {
  allow read, list: if request.auth != null;
  allow create, update: if request.auth != null;
}

match /receiveHelp/{docId} {
  allow read, list: if request.auth != null;
  allow create, update: if request.auth != null;
}

match /helpHistory/{docId} {
  // Allow read/list for all authenticated users to prevent LIST evaluation failures
  allow read: if isAuthenticated();
  allow list: if isAuthenticated();
  // Ownership checks only on write operations
  allow write, create: if isAuthenticated() && isAdmin();
}

match /epins/{docId} {
  allow read: if isAuthenticated();
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || request.auth.uid == resource.data.createdBy || isAdminOrAgent());
  allow create: if isAuthenticated();
  allow list: if isAuthenticated();
}

match /epinRequests/{docId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdminOrAgent());
  allow create: if isAuthenticated() && (request.auth.uid == request.resource.data.userId || isAdminOrAgent());
  allow list: if isAuthenticated();
}

match /testimonials/{docId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.uid || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.uid || isAdminOrAgent());
  allow create: if isAuthenticated() && (request.auth.uid == request.resource.data.uid || isAdminOrAgent());
  allow list: if isAuthenticated();
}

match /socialTasks/{userId} {
  allow read: if isAuthenticated() && (request.auth.uid == userId || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
  allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
  allow list: if isAuthenticated() && isAdminOrAgent();
}

match /notifications/{docId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdmin());
  allow create: if isAuthenticated();
  allow list: if isAuthenticated();
}

match /supportTickets/{docId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.agentId || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.agentId || isAdminOrAgent());
  allow create: if isAuthenticated() && (request.auth.uid == request.resource.data.userId || isAdminOrAgent());
  allow list: if isAuthenticated();
}

match /fcmTokens/{userId} {
  allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
  allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
  allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
  allow list: if isAuthenticated() && isAdmin();
}
match /payments/{docId} {
  // Allow read/list for all authenticated users to prevent LIST evaluation failures
  allow read: if isAuthenticated();
  allow list: if isAuthenticated();
  // Ownership checks only on write operations
  allow write, create: if isAuthenticated() && isAdminOrAgent();
}

match /settings/{docId} {
  allow read: if isAuthenticated();
  allow write, create: if isAuthenticated() && isAdmin();
  allow list: if isAuthenticated();
}

match /globalSettings/{docId} {
  allow read: if isAuthenticated() && isAdminOrAgent();
  allow write, create: if isAuthenticated() && isAdmin();
  allow list: if isAuthenticated() && isAdminOrAgent();
}

match /broadcasts/{docId} {
  allow read, list: if isAuthenticated();
  allow write, create: if isAuthenticated() && isAdmin();
}

match /levels/{docId} {
  allow read, list: if isAuthenticated();
  allow write, create: if isAuthenticated() && isAdmin();
}


match /systemConfig/{docId} {
  allow read: if isAuthenticated();
  allow write, create: if isAuthenticated() && isAdmin();
  allow list: if isAuthenticated() && isAdminOrAgent();
}

match /transactionLogs/{docId} {
  // Allow read/list for all authenticated users to prevent LIST evaluation failures
  allow read: if isAuthenticated();
  allow list: if isAuthenticated();
  // Ownership checks only on write operations
  allow write, create: if isAuthenticated() && isAdmin();
}

match /agentDashboard/{docId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.agentId || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.agentId || isAdmin());
  allow create: if isAuthenticated() && isAdminOrAgent();
  allow list: if isAuthenticated();
}

match /tickets/{docId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.assignedAgent || isAdminOrAgent());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.assignedAgent || isAdminOrAgent());
  allow create: if isAuthenticated();
  allow list: if isAuthenticated();
}

match /helpChats/{chatId} {
  allow read, list, create, update, delete: if request.auth != null;

  match /messages/{messageId} {
    allow read, list, create, update, delete: if request.auth != null;
  }
}

match /appSettings/{docId} {
  allow read: if isAuthenticated();
  allow list: if isAuthenticated();
  allow write, create: if isAuthenticated() && isAdmin();
}

match /chatbotChats/{chatId} {
  allow read: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdmin());
  allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdmin());
  allow create: if isAuthenticated() && (request.auth.uid == request.resource.data.userId || isAdmin());
  allow list: if isAuthenticated();

  match /messages/{messageId} {
    allow read: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/chatbotChats/$(chatId)).data.userId || isAdmin());
    allow write: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/chatbotChats/$(chatId)).data.userId || isAdmin());
    allow create: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/chatbotChats/$(chatId)).data.userId || isAdmin());
    allow list: if isAuthenticated() && (request.auth.uid == get(/databases/$(database)/documents/chatbotChats/$(chatId)).data.userId || isAdmin());
  }
}

match /test/{docId} {
  allow read, write, create, list: if isAuthenticated() && isAdmin();
}

} }
>>>>>>> 60b3a7f821302b61dfef9887afd598a9a3deb9d5
